const playerChannel=new BroadcastChannel('player_channel');const roleChannel=new BroadcastChannel('role_channel');const statusChannel=new BroadcastChannel('status_channel');const bestMoveChannel=new BroadcastChannel('best_move_channel');const resetChannel=new BroadcastChannel('reset_channel');const resetAllChannel=new BroadcastChannel('reset_all_channel');axios.defaults.baseURL=window.baseURL;const defaultImages={civil:'',mafia:'',};let initialDocument;async function getDefaultImages(){let data;try{await axios.get('/default',{headers:{Authorization:'Bearer '+window.token}}).then((response)=>(data=response.data)).catch((error)=>console.error('[Запрос] Ошибка:',error.message))}catch(error){console.error('Ошибка:',error.message)}
if(!data){console.error('Ошибка запроса стандартных фотографий с сервера');return}
defaultImages.civil=data.civil;defaultImages.mafia=data.mafia;const players=document.querySelectorAll('.card-container');players.forEach((player)=>{player.children[1].style.backgroundImage=`url("${defaultImages.civil}")`});initDocument()}
function init(){getDefaultImages()}
playerChannel.onmessage=(event)=>{const data=event.data;const player=document.getElementById(`${data.pos}`);player.setAttribute('image','custom');player.children[1].style.backgroundImage=data.player.image===''?getDefaultImage(player):`url("${data.player.image})`;player.children[2].children[1].innerHTML=data.player.name};roleChannel.onmessage=(event)=>{const data=event.data;const player=document.getElementById(`${data.pos}`);const role=player.children[1];if(data.role==='Civil'||data.role==='Mafia'){role.children[0].style.display='none';role.children[0].children[0].style.display='none';role.children[0].children[1].style.display='none';if(data.role==='Civil'){role.className=role.className.includes('removed')?'card-photo civil removed':'card-photo civil';player.children[0].className='card-bestMove background-civil';player.children[2].className='card-info background-civil';player.setAttribute('role','civil')}else{role.className=role.className.includes('removed')?'card-photo mafia removed':'card-photo mafia';player.children[0].className='card-bestMove background-mafia';player.children[2].className='card-info background-mafia';player.setAttribute('role','mafia')}}else{if(data.role==='Sheriff'){role.children[0].style.display='flex';role.children[0].children[0].style.display='block';role.children[0].children[1].style.display='none';role.className=role.className.includes('removed')?'card-photo civil removed':'card-photo civil';player.children[0].className='card-bestMove background-civil';player.children[1].children[0].className='card-role background-civil';player.children[2].className='card-info background-civil';player.setAttribute('role','civil')}else{role.children[0].style.display='flex';role.children[0].children[0].style.display='none';role.children[0].children[1].style.display='block';role.className=role.className.includes('removed')?'card-photo mafia removed':'card-photo mafia';player.children[0].className='card-bestMove background-mafia';player.children[1].children[0].className='card-role background-mafia';player.children[2].className='card-info background-mafia';player.setAttribute('role','mafia')}}
changeImage(player)};statusChannel.onmessage=(event)=>{const data=event.data;const player=document.getElementById(`${data.pos}`);const bestMove=player.children[0];const killed=player.children[1].children[1].children[0].children[0];const removed=player.children[1].children[1].children[0].children[1];const upvoted=player.children[1].children[1].children[0].children[2];if(data.status==='Alive'){player.children[1].className=player.children[1].className.replace(' removed','');player.children[1].children[1].className=player.children[1].children[1].className.replace(' removed','',);killed.style.display='none';removed.style.display='none';upvoted.style.display='none';bestMove.style.display='none';bestMove.id=''}else{player.children[1].className=player.children[1].className.includes(' removed')?player.children[1].className:player.children[1].className+' removed';player.children[1].children[1].className=player.children[1].children[1].className.includes(' removed',)?player.children[1].children[1].className:player.children[1].children[1].className+' removed';if(data.status==='First'){killed.style.display='block';removed.style.display='none';upvoted.style.display='none';bestMove.style.display='flex';bestMove.id='activeBestMove'}else{if(data.status==='Killed'){killed.style.display='block';removed.style.display='none';upvoted.style.display='none'}else if(data.status==='Upvoted'){upvoted.style.display='block';killed.style.display='none';removed.style.display='none'}else{removed.style.display='block';killed.style.display='none';upvoted.style.display='none'}
bestMove.style.display='none';bestMove.id=''}}};bestMoveChannel.onmessage=(event)=>{const data=event.data;document.querySelectorAll('#activeBestMove').forEach((bestMoveElement)=>{switch(data.bestMoveId){case 1:bestMoveElement.children[1].children[0].innerHTML=data.number;break;case 2:bestMoveElement.children[1].children[2].innerHTML=data.number;break;case 3:bestMoveElement.children[1].children[4].innerHTML=data.number;break}})};resetChannel.onmessage=()=>{const players=document.querySelectorAll('.card-container');players.forEach((player)=>{player.setAttribute('role','civil');const bestMove=player.children[0];bestMove.id='';bestMove.style.display='none';bestMove.className='card-bestMove background-civil';const bmNumBlock=bestMove.children[1];bmNumBlock.children[0].innerHTML='?';bmNumBlock.children[2].innerHTML='?';bmNumBlock.children[4].innerHTML='?';const cardPhoto=player.children[1];cardPhoto.className='card-photo civil';const cardRole=cardPhoto.children[0];cardRole.style.display='none';cardRole.className='card-role background-civil';cardRole.children[0].style.display='none';cardRole.children[1].style.display='none';const cardStatusContainer=cardPhoto.children[1];cardStatusContainer.className='card-status-container';const cardStatus=cardStatusContainer.children[0];cardStatus.children[0].style.display='none';cardStatus.children[1].style.display='none';cardStatus.children[2].style.display='none';const cardInfo=player.children[2];cardInfo.className='card-info background-civil'})};resetAllChannel.onmessage=()=>{const container=document.getElementById('container');const body=document.getElementById('body');const containerClone=initialDocument.cloneNode(!0);body.removeChild(container);body.appendChild(containerClone)};function getDefaultImage(player){player.setAttribute('image','default');if(player.getAttribute('role')==='civil')return `url("${defaultImages.civil}")`;return `url("${defaultImages.mafia}")`}
function changeImage(player){if(player.getAttribute('image')==='custom')return;if(player.getAttribute('role')==='civil')
player.children[1].style.backgroundImage=`url("${defaultImages.civil}")`;else player.children[1].style.backgroundImage=`url("${defaultImages.mafia}")`}
function initDocument(){const container=document.getElementById('container');initialDocument=container.cloneNode(!0)}
init()